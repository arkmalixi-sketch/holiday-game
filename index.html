<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Holiday Game Board</title>
    <style>
        /* --- VISUALS --- */
        :root {
            --bg-color: linear-gradient(135deg, #003319 0%, #001a4d 100%);
            --tile-bg: rgba(255, 255, 255, 0.15);
            --tile-border: rgba(255, 255, 255, 0.3);
            --text-color: white;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* LEFT SIDE: BOARD */
        #board-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center; 
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }

        .tile {
            height: 80px;
            background: var(--tile-bg);
            border: 1px solid var(--tile-border);
            border-radius: 12px;
            position: relative;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .tile-number {
            position: absolute;
            top: 5px;
            left: 8px;
            font-size: 10px;
            font-weight: bold;
            opacity: 0.6;
        }

        .tile-icon { font-size: 24px; opacity: 0.8; }

        .pawn-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 2px;
        }

        .pawn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            text-shadow: 0 1px 2px black;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            cursor: pointer;
        }

        /* LEADERBOARD */
        #leaderboard-panel {
            width: 100%;
            max-width: 800px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            margin-top: auto; 
            border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }

        .lb-row {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: rgba(255,255,255,0.1);
            margin-bottom: 5px;
            border-radius: 6px;
        }
        
        .lb-rank { width: 30px; font-weight: bold; color: #ccc; }
        .lb-name { flex: 1; font-weight: bold; color: white; }
        .lb-status { font-size: 12px; color: #ddd; background: rgba(0,0,0,0.3); padding: 3px 6px; border-radius: 4px; }

        /* RIGHT SIDE: CONTROLS */
        #controls {
            width: 320px;
            background: #f5f5f5;
            color: #333;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ccc;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            z-index: 10;
        }

        #header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }

        h1 { margin: 0; font-size: 24px; color: #006633; white-space: pre-wrap; }
        h2 { margin: 5px 0 0 0; font-size: 12px; color: #666; font-weight: normal; }
        
        #connection-status {
            font-size: 11px;
            font-weight: bold;
            margin-top: 5px;
            padding: 4px;
            background: #eee;
            border-radius: 4px;
            color: #ff3b30; /* Default Red */
        }

        #player-input {
            padding: 15px;
            display: flex;
            gap: 5px;
            border-bottom: 1px solid #ddd;
        }

        input[type="text"], input[type="number"] {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }

        button {
            padding: 8px 12px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { opacity: 0.9; }

        #player-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .player-row {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .del-btn { background: #ff3b30; padding: 4px 8px; font-size: 12px; }
        .move-btn { background: #34c759; padding: 4px 8px; }
        .back-btn { background: #007AFF; padding: 4px 8px; }

        /* MODAL & SETTINGS */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 16px;
            width: 320px;
            max-height: 85vh;
            overflow-y: auto;
            text-align: center;
            color: black;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .settings-group {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 10px 15px;
            margin-bottom: 15px;
            border: 1px solid #eee;
            text-align: left;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
            font-size: 15px;
            font-weight: 500;
        }
        .settings-row:last-child { border-bottom: none; }
        
        .settings-row label { cursor: pointer; flex: 1; text-align: left; }
        input[type="checkbox"] { width: 22px; height: 22px; cursor: pointer; accent-color: #34c759; }

        #custom-inputs {
            display: none;
            background: #eef;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: left;
            border: 1px solid #ccf;
        }
        .input-label { font-size: 11px; color: #666; margin-bottom: 4px; display: block; font-weight:bold; }
        
        .snow { position: absolute; font-size: 40px; opacity: 0.1; user-select: none; pointer-events: none;}
    </style>
</head>
<body>

    <div id="board-container">
        <div class="snow" style="top: 20px; left: 20px;">‚ùÑÔ∏è</div>
        <div class="snow" style="bottom: 20px; right: 20px;">‚ùÑÔ∏è</div>
        <div id="grid"></div>
        <div id="leaderboard-panel">
            <div style="color: orange; font-weight: bold; margin-bottom: 10px; font-size: 18px;">üèÜ LIVE STANDINGS</div>
            <div id="lb-list"></div>
        </div>
    </div>

    <div id="controls">
        <div id="header">
            <h1 id="board-title">Holiday<br>Game Board</h1>
            <h2 id="board-desc">üéÅ 1k Gift = 1 Move Forward</h2>
            <div id="connection-status">üî¥ Disconnected (Streamer.bot)</div>
            <button onclick="connectWebSocket()" style="margin-top:10px; background:#5856d6; font-size:11px; width:100%;">üì° Reconnect</button>
            <button onclick="openSettings()" style="margin-top:5px; background:#8e8e93; font-size:13px; width:100%;">‚öôÔ∏è Settings & Randomize</button>
        </div>

        <div id="player-input">
            <input type="text" id="new-name" placeholder="Name (Max 4)" maxlength="4">
            <button onclick="addPlayer()">+</button>
        </div>

        <div style="padding: 10px 10px 0 10px; font-size: 12px; color: #888;">Manual Controls:</div>
        <div id="player-list"></div>

        <button onclick="resetBoard()" style="margin: 10px; background: transparent; color: red; border: 1px solid red;">Reset Board</button>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h2 id="alert-title" style="margin-top:0;">Title</h2>
            <p id="alert-msg" style="font-size: 16px; margin: 20px 0;">Message</p>
            <button onclick="closeModal()" style="width:100%; font-size:16px;">Awesome!</button>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h2 style="margin-top:0;">Settings</h2>
            
            <div class="settings-group">
                <div class="settings-row">
                    <label for="set-theme">Use Holiday Theme üéÑ</label>
                    <input type="checkbox" id="set-theme" checked onchange="toggleTheme()">
                </div>
                <div style="margin-top:15px;">
                    <span class="input-label">Board Title:</span>
                    <input type="text" id="set-board-title" style="width:100%; box-sizing: border-box; margin-bottom:10px;">
                    <span class="input-label">Instruction / Cost:</span>
                    <input type="text" id="set-board-desc" style="width:100%; box-sizing: border-box;">
                    <button onclick="saveSettings()" style="width:100%; margin-top:8px; background: #007AFF; font-size:12px;">Update Text</button>
                </div>
            </div>
            
            <div class="settings-group">
                <div class="settings-row"><label for="set-trap">‚õîÔ∏è Hidden Trap</label><input type="checkbox" id="set-trap" checked onchange="saveSettings()"></div>
                <div class="settings-row"><label for="set-spin">üé∞ Spin Wheel</label><input type="checkbox" id="set-spin" checked onchange="saveSettings()"></div>
                <div class="settings-row"><label for="set-shirt">üëï T-Shirt</label><input type="checkbox" id="set-shirt" checked onchange="saveSettings()"></div>
                <div class="settings-row"><label for="set-gold">üëë Golden Pawn</label><input type="checkbox" id="set-gold" checked onchange="saveSettings()"></div>
                <div class="settings-row"><label for="set-points">üíé Live Points</label><input type="checkbox" id="set-points" checked onchange="saveSettings()"></div>
            </div>
            
            <div class="settings-group">
                <div class="settings-row">
                    <label for="set-custom">üéÅ Custom Tile</label>
                    <input type="checkbox" id="set-custom" onchange="toggleCustomUI()">
                </div>
            </div>
            
            <div id="custom-inputs">
                <div class="settings-row" style="border:none; padding:0 0 10px 0;">
                    <label>Tile Position (1-28):</label>
                    <input type="number" id="custom-idx" value="15" min="1" max="28" style="width: 50px;">
                </div>
                <span class="input-label">Popup Title:</span>
                <input type="text" id="custom-title" value="MYSTERY BOX!" style="width: 100%; box-sizing: border-box; margin-bottom: 10px;">
                <span class="input-label">Popup Message:</span>
                <input type="text" id="custom-msg" value="You found the secret stash!" style="width: 100%; box-sizing: border-box;">
                <button onclick="saveSettings()" style="width:100%; margin-top:10px; background: #007AFF;">Apply</button>
            </div>
            
            <button onclick="randomizeBoard()" style="width:100%; background: purple; margin-bottom: 10px; padding: 12px;">üîÄ Randomize Board</button>
            <button onclick="document.getElementById('settings-modal').style.display='none'" style="width:100%; background: #ccc; color: black; padding: 12px;">Close</button>
        </div>
    </div>

    <script>
        // --- GAME VARIABLES ---
        let players = [], bonuses = [], winnerCount = 0;
        const totalTiles = 30;
        const colors = ['#ff3b30', '#007aff', '#ff9500', '#af52de', '#ff2d55', '#5ac8fa', '#34c759', '#FFD700']; 

        // --- WEBSOCKET CONNECTION ---
        let socket;
        function connectWebSocket() {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerText = "üü° Connecting...";
            statusDiv.style.color = "orange";
            
            // Connect to local Streamer.bot
            socket = new WebSocket("ws://127.0.0.1:8080/");

            socket.onopen = () => {
                statusDiv.innerText = "üü¢ Connected to Streamer.bot";
                statusDiv.style.color = "green";
                // Subscribe to TikTok Gifts
                socket.send(JSON.stringify({
                    "request": "Subscribe",
                    "events": { "TikTok": ["Gift"] },
                    "id": "123"
                }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if(data.event && data.event.source === 'TikTok' && data.event.type === 'Gift') {
                    handleStreamEvent(data);
                }
            };

            socket.onclose = () => {
                statusDiv.innerText = "üî¥ Disconnected (Retry)";
                statusDiv.style.color = "red";
            };
        }

        // --- HANDLING GIFTS ---
        function handleStreamEvent(data) {
            const username = data.data.user.name;
            const giftName = data.data.gift.name;
            // Default: 1 Gift = 1 Move. (You can change this logic here)
            const moves = 1; 
            
            // 1. Find or Create Player
            let player = players.find(p => p.name.toUpperCase() === username.toUpperCase().substring(0,4));
            
            if (!player) {
                // Auto-Add new player
                const newId = Date.now();
                player = {
                    id: newId,
                    name: username.toUpperCase().substring(0, 4),
                    tileIndex: 0,
                    colorIndex: Math.floor(Math.random() * 7),
                    finishRank: null
                };
                players.push(player);
                saveData();
            }
            
            // 2. Move them
            movePlayer(player.id, moves);
        }

        // --- CORE FUNCTIONS ---
        loadData();
        if(bonuses.length === 0) setupDefaultBonuses();
        
        const customBonus = bonuses.find(b => b.type === "CUSTOM");
        if(customBonus) {
            document.getElementById('set-custom').checked = true;
            document.getElementById('custom-inputs').style.display = 'block';
            document.getElementById('custom-idx').value = customBonus.tileIndex + 1;
            if(customBonus.customTitle) document.getElementById('custom-title').value = customBonus.customTitle;
            if(customBonus.customMsg) document.getElementById('custom-msg').value = customBonus.customMsg;
        }

        renderBoard();
        renderPlayers();
        
        // Try connecting immediately
        connectWebSocket();

        // --- UI HELPERS ---
        function openSettings() {
            document.getElementById('settings-modal').style.display = 'flex';
            document.getElementById('set-board-title').value = document.getElementById('board-title').innerText;
            document.getElementById('set-board-desc').value = document.getElementById('board-desc').innerText;
        }

        function toggleCustomUI() {
            const isChecked = document.getElementById('set-custom').checked;
            const ui = document.getElementById('custom-inputs');
            ui.style.display = isChecked ? 'block' : 'none';
            saveSettings();
        }

        function saveSettings() {
            const newTitle = document.getElementById('set-board-title').value;
            const newDesc = document.getElementById('set-board-desc').value;
            document.getElementById('board-title').innerText = newTitle;
            document.getElementById('board-desc').innerText = newDesc;

            const isCustomEnabled = document.getElementById('set-custom').checked;
            bonuses = bonuses.filter(b => b.type !== "CUSTOM"); 
            
            if (isCustomEnabled) {
                const tileVal = parseInt(document.getElementById('custom-idx').value) - 1; 
                const title = document.getElementById('custom-title').value;
                const msg = document.getElementById('custom-msg').value;
                bonuses.push({
                    id: 999, tileIndex: tileVal, type: "CUSTOM", isClaimed: false, customTitle: title, customMsg: msg
                });
            }
            saveData();
            renderBoard();
        }

        function addPlayer() {
            const input = document.getElementById('new-name');
            const name = input.value.toUpperCase().substring(0, 4);
            if (!name) return;
            const newPlayer = { id: Date.now(), name: name, tileIndex: 0, colorIndex: Math.floor(Math.random() * 7), finishRank: null };
            players.push(newPlayer);
            input.value = '';
            saveData();
            renderPlayers();
            renderBoard();
        }

        function movePlayer(id, steps) {
            const index = players.findIndex(p => p.id === id);
            if (index === -1) return;
            if (players[index].finishRank !== null) return; 

            let newIndex = players[index].tileIndex + steps;

            if (newIndex >= 0 && newIndex < totalTiles) {
                players[index].tileIndex = newIndex;
                if (steps > 0) checkForBonus(index, newIndex);
                if (newIndex === totalTiles - 1) handleWinner(index);
                saveData();
                renderPlayers();
                renderBoard();
            }
        }

        function deletePlayer(id) {
            if(confirm("Delete this player?")) {
                players = players.filter(p => p.id !== id);
                saveData();
                renderPlayers();
                renderBoard();
            }
        }

        function resetBoard() {
            if(confirm("Reset the whole board?")) {
                players = [];
                winnerCount = 0;
                setupDefaultBonuses();
                if(document.getElementById('set-custom').checked) saveSettings();
                saveData();
                renderPlayers();
                renderBoard();
            }
        }

        function checkForBonus(pIndex, tileIndex) {
            const bonusIdx = bonuses.findIndex(b => b.tileIndex === tileIndex && !b.isClaimed);
            if (bonusIdx === -1) return;

            const bonus = bonuses[bonusIdx];
            if (!isBonusEnabled(bonus.type)) return;

            let title = ""; let msg = ""; let teleport = false;

            if (bonus.type === "TRAP") {
                title = "‚õîÔ∏è OOPS! TRAP! ‚õîÔ∏è"; msg = `${players[pIndex].name} slipped and fell back 1 space!`;
                players[pIndex].tileIndex = Math.max(0, tileIndex - 1); teleport = true;
            } else if (bonus.type === "POINTS") {
                title = "üíé LIVE POINTS! üíé"; msg = `${players[pIndex].name} found 100 Live Points!`; teleport = true;
            } else if (bonus.type === "SHIRT") {
                title = "üëï T-SHIRT UNLOCKED! üëï"; msg = "Put their name on a shirt!"; bonus.isClaimed = true;
            } else if (bonus.type === "SPIN") {
                title = "üé∞ SPIN THE WHEEL! üé∞"; msg = "Spin the wheel for a prize!"; bonus.isClaimed = true;
            } else if (bonus.type === "GOLD") {
                title = "üëë GOLD STATUS! üëë"; msg = `${players[pIndex].name} is now GOLDEN!`;
                players[pIndex].colorIndex = 7; bonus.isClaimed = true;
            } else if (bonus.type === "CUSTOM") {
                title = `‚ú® ${bonus.customTitle || "MYSTERY"} ‚ú®`; msg = bonus.customMsg || "You found the secret stash!"; bonus.isClaimed = true;
            }

            showAlert(title, msg);
            
            if (teleport) {
                let newSpot;
                do { newSpot = Math.floor(Math.random() * (totalTiles - 2)) + 1; }
                while (newSpot === tileIndex || bonuses.some(b => b.tileIndex === newSpot && !b.isClaimed));
                bonus.tileIndex = newSpot;
            }
        }

        function handleWinner(pIndex) {
            winnerCount++;
            players[pIndex].finishRank = winnerCount;
            let title = "üéâ FINISHER! üéâ";
            let msg = `${players[pIndex].name} finished!`;
            if(winnerCount === 1) { title = "üèÜ 1ST PLACE! üèÜ"; msg = "GRAND PRIZE WINNER!"; }
            if(winnerCount === 2) { title = "ü•à 2ND PLACE! ü•à"; }
            if(winnerCount === 3) { title = "ü•â 3RD PLACE! ü•â"; }
            showAlert(title, msg);
        }

        function renderBoard() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';

            for (let i = 0; i < totalTiles; i++) {
                const tile = document.createElement('div');
                tile.className = 'tile';
                const num = document.createElement('div');
                num.className = 'tile-number';
                num.innerText = i + 1;
                tile.appendChild(num);

                const bonus = bonuses.find(b => b.tileIndex === i && !b.isClaimed);
                if (bonus && isBonusEnabled(bonus.type)) {
                    const icon = document.createElement('div');
                    icon.className = 'tile-icon';
                    if (bonus.type === "TRAP") icon.innerText = "";
                    if (bonus.type === "POINTS") icon.innerText = "üíé";
                    if (bonus.type === "SHIRT") icon.innerText = "üëï";
                    if (bonus.type === "SPIN") icon.innerText = "üé∞";
                    if (bonus.type === "GOLD") icon.innerText = "üëë";
                    if (bonus.type === "CUSTOM") icon.innerText = "üéÅ";
                    
                    if (bonus.type !== "TRAP") tile.style.backgroundColor = "rgba(255, 255, 255, 0.25)";
                    if (bonus.type === "SHIRT") tile.style.borderColor = "orange";
                    if (bonus.type === "GOLD") tile.style.borderColor = "yellow";
                    if (bonus.type === "CUSTOM") { tile.style.borderColor = "pink"; tile.style.backgroundColor = "rgba(255, 105, 180, 0.2)"; }
                    
                    tile.appendChild(icon);
                }
                
                if (i === 29) {
                    const star = document.createElement('div');
                    star.innerText = "‚≠êÔ∏è";
                    star.className = 'tile-icon';
                    tile.style.borderColor = "yellow";
                    tile.appendChild(star);
                }

                const playersHere = players.filter(p => p.tileIndex === i);
                if (playersHere.length > 0) {
                    const container = document.createElement('div');
                    container.className = 'pawn-container';
                    playersHere.forEach(p => {
                        const pawn = document.createElement('div');
                        pawn.className = 'pawn';
                        pawn.style.backgroundColor = colors[p.colorIndex];
                        pawn.innerText = p.name;
                        container.appendChild(pawn);
                    });
                    if (tile.querySelector('.tile-icon')) tile.querySelector('.tile-icon').style.display = 'none';
                    tile.appendChild(container);
                }
                grid.appendChild(tile);
            }
            renderLeaderboard();
        }

        function renderPlayers() {
            const list = document.getElementById('player-list');
            list.innerHTML = '';

            players.forEach(p => {
                const row = document.createElement('div');
                row.className = 'player-row';
                
                const delBtn = document.createElement('button');
                delBtn.innerText = "üóëÔ∏è";
                delBtn.className = "del-btn";
                delBtn.onclick = () => deletePlayer(p.id);

                const nameDiv = document.createElement('div');
                nameDiv.style.fontWeight = "bold";
                nameDiv.style.flex = "1";
                nameDiv.style.color = colors[p.colorIndex];
                nameDiv.innerText = p.name;

                row.appendChild(delBtn);
                row.appendChild(nameDiv);

                if (p.finishRank === null) {
                    const backBtn = document.createElement('button');
                    backBtn.className = "back-btn";
                    backBtn.innerText = "‚¨ÖÔ∏è";
                    backBtn.onclick = () => movePlayer(p.id, -1);

                    const tileNum = document.createElement('span');
                    tileNum.style.fontWeight = "bold";
                    tileNum.style.color = "#333";
                    tileNum.innerText = p.tileIndex + 1;

                    const fwdBtn = document.createElement('button');
                    fwdBtn.className = "move-btn";
                    fwdBtn.innerText = "‚û°Ô∏è";
                    fwdBtn.onclick = () => movePlayer(p.id, 1);

                    row.appendChild(backBtn);
                    row.appendChild(tileNum);
                    row.appendChild(fwdBtn);
                } else {
                    const finDiv = document.createElement('div');
                    finDiv.innerText = "‚úÖ DONE";
                    finDiv.style.color = "green";
                    finDiv.style.fontWeight = "bold";
                    row.appendChild(finDiv);
                }
                list.appendChild(row);
            });
        }

        function renderLeaderboard() {
            const lb = document.getElementById('lb-list');
            lb.innerHTML = '';
            
            if(players.length === 0) {
                document.getElementById('leaderboard-panel').style.display = 'none';
                return;
            }
            document.getElementById('leaderboard-panel').style.display = 'block';

            const sorted = [...players].sort((a, b) => {
                if (a.finishRank && b.finishRank) return a.finishRank - b.finishRank;
                if (a.finishRank) return -1;
                if (b.finishRank) return 1;
                return b.tileIndex - a.tileIndex;
            });

            sorted.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'lb-row';
                const rankText = p.finishRank ? `üèÜ #${p.finishRank}` : `#${index + 1}`;
                const statusText = p.finishRank ? "FINISHED" : `Tile ${p.tileIndex + 1}`;
                const nameColor = p.finishRank ? "#FFD700" : "white";
                div.innerHTML = `<span class="lb-rank">${rankText}</span><span class="lb-name" style="color:${nameColor}">${p.name}</span><span class="lb-status">${statusText}</span>`;
                lb.appendChild(div);
            });
        }

        function setupDefaultBonuses() {
            bonuses = [
                { id: 1, tileIndex: 6, type: "TRAP", isClaimed: false },
                { id: 2, tileIndex: 11, type: "SPIN", isClaimed: false },
                { id: 3, tileIndex: 17, type: "SHIRT", isClaimed: false },
                { id: 4, tileIndex: 19, type: "GOLD", isClaimed: false },
                { id: 5, tileIndex: 24, type: "POINTS", isClaimed: false },
                { id: 6, tileIndex: 8, type: "POINTS", isClaimed: false }
            ];
        }

        function isBonusEnabled(type) {
            if(type === "CUSTOM") return document.getElementById('set-custom').checked;
            const map = { "TRAP": 'set-trap', "SPIN": 'set-spin', "SHIRT": 'set-shirt', "GOLD": 'set-gold', "POINTS": 'set-points' };
            const el = document.getElementById(map[type]);
            return el ? el.checked : true;
        }

        function randomizeBoard() {
            bonuses.forEach(b => {
                let newSpot;
                do { newSpot = Math.floor(Math.random() * (totalTiles - 2)) + 1; }
                while (bonuses.some(other => other.tileIndex === newSpot && other.id !== b.id));
                b.tileIndex = newSpot;
            });
            saveSettings();
            renderBoard();
        }

        function saveData() {
            localStorage.setItem('holiday_players', JSON.stringify(players));
            localStorage.setItem('holiday_bonuses', JSON.stringify(bonuses));
            localStorage.setItem('holiday_winners', winnerCount);
            const t = document.getElementById('board-title').innerText;
            const d = document.getElementById('board-desc').innerText;
            localStorage.setItem('holiday_title', t);
            localStorage.setItem('holiday_desc', d);
        }

        function loadData() {
            const p = localStorage.getItem('holiday_players');
            const b = localStorage.getItem('holiday_bonuses');
            const w = localStorage.getItem('holiday_winners');
            if(p) players = JSON.parse(p);
            if(b) bonuses = JSON.parse(b);
            if(w) winnerCount = parseInt(w);
            const t = localStorage.getItem('holiday_title');
            const d = localStorage.getItem('holiday_desc');
            if(t) document.getElementById('board-title').innerText = t;
            if(d) document.getElementById('board-desc').innerText = d;
        }

        function toggleTheme() {
            const isHoliday = document.getElementById('set-theme').checked;
            document.body.style.background = isHoliday ? "linear-gradient(135deg, #003319 0%, #001a4d 100%)" : "#1a1a1a";
            renderBoard();
        }

        function showAlert(title, msg) {
            document.getElementById('alert-title').innerText = title;
            document.getElementById('alert-msg').innerText = msg;
            document.getElementById('alert-modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('alert-modal').style.display = 'none'; }
    </script>
</body>
</html>
